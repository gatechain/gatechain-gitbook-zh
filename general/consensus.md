# GateChain 共识机制

基于通用的 POS 机制，GateChain 进行了进一步优化，使用户更容易参与网络共识、实现资产增值和去中心化管理。与大多数 POS 经济模型不同，GateChain 注重资产收益的包容性，让更多用户能够轻松参与共识，同时保护 GateChain 的安全稳定运行并获得合理回报。

## 关键术语

### GateToken (GT)
GateChain 主网的原生代币，用于一般价值交换、交易费用支付和确定共识权重。

### 共识账户 (Con-account)
持有非零 GT 余额的普通账户，通过发起"共识账户上线"交易并支付费用（等同于当时的普通转账费用）成为共识账户。共识账户有资格参与每轮共识，参与程度取决于持有的 GT 数量。共识开始后，共识账户进行"自选"，如果被选中，则进入"委员会"进行区块提议和验证。

### 共识权重 (Power)
共识账户持有的 GT 的加权计算决定其共识权重。这个权重作为自选算法的输入参数，决定账户被选入委员会的长期概率。

### VRF 选择
使用 VRF（可验证随机函数）算法进行随机概率计算，被选中的概率取决于 GT 的加权总和和网络总 GT。长期概率分布对应于共识账户持有的 GT 占整个网络的比例。

### 委员会
通过 VRF 选择的共识账户进入当前共识轮次的委员会。委员会负责本轮的提议、验证和投票。委员会成员有机会获得区块奖励和交易费用。

### 委员会领导者
在每个共识轮次中，从委员会中以相等概率选择三个共识账户成为领导者。领导者获得该轮的区块奖励。

## Gatemint 共识流程

### 1. 提议阶段
1. 所有共识账户（con-accounts）开始 VRF 选择
2. 被选中的账户从交易池组织交易并打包成新区块
3. 将新区块和 VRF 证明广播给所有节点

### 2. 软投票阶段
1. 每个节点接收 n 个新提议的区块 + 证明
2. 首先验证提议节点是否真的被选中（使用 VRF 算法验证提议节点的公钥和证明）
3. 验证后，计算所有已验证证明的哈希，结果最小的成为本轮目标区块
4. 所有账户进行自选，被选中的账户对计算出的区块进行投票并广播投票信息
5. 所有节点收集投票信息，当票数超过 2/3 时本轮结束，进入下一步

### 3. 认证投票阶段
1. 每个账户进行自选
2. 被选中的账户开始验证软投票选中的区块是否存在双花等问题
3. 验证后进行投票并广播
4. 所有节点收集本轮投票，超过 2/3 时将区块持久化到本地存储
5. 当前区块共识结束，开始下一轮

## 共识账户（Con-account）属性

### 1. 支付密钥
账户创建时默认生成的密钥对，主要用于转账
- 公钥：用于签名验证
- 私钥：用于交易签名
- 地址：由加密公钥派生的 74 字符字符串，作为账户标识符

### 2. 参与密钥
参与共识所需的密钥对，通过单独命令生成
- VRF 公钥
  - 用于验证账户自选结果，作为验证函数的输入与选择证明一起使用
- VRF 私钥
  - 用于自选，作为选择函数的输入与网络范围种子一起使用，输出（结果，证明）
- 投票密钥集
  - 生成参与密钥时，必须指定参与共识的区块高度范围（FirstValid, LastValid）
  - 投票密钥集数量与高度范围一一对应，每个参与区块生成一个投票密钥，区块完成后删除

### 3. 状态
账户共识参与状态
- 在线
  - 账户必须有高于最低余额且预先生成参与密钥才能参与
  - 状态变更交易确认后，所有节点记录账户的 VRF 公钥用于后续选择验证
  - 状态变更在 320 个区块高度后生效，防止恶意频繁变更状态
- 离线
  - 账户初始状态，不参与共识

### 4. 余额
账户余额

**注意：**
1. 每个节点可以包含多个账户，每个账户都能发送上线交易参与共识。在共识过程中，节点轮询所有本地共识账户进行自选。
2. 被选中的共识账户进入委员会进行提议、验证和投票。委员会成员可能获得区块奖励和交易费用。以相等概率选择的三个领导者获得区块奖励。
